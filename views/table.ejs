<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Donation List</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <div class="menu-container">
          <button class="menu-button" onclick="toggleMenu()">
            <i class="fas fa-bars"></i>
          </button>
          <div class="dropdown-menu" id="dropdownMenu">
            <% if (isLoggedInToQuickbooks) { %>
              <a href="#" onclick="openOrganizationDialog()">
                <i class="fas fa-building"></i>
                Organization
              </a>
              <a href="#" onclick="openLogoDialog()">
                <i class="fas fa-image"></i>
                Logo
              </a>
            <% } else { %>
              <a href="#" class="disabled" title="Please connect to QuickBooks first" onclick="openOrganizationDialog()">
                <i class="fas fa-building"></i>
                Organization
              </a>
              <a href="#" class="disabled" title="Please connect to QuickBooks first" onclick="openLogoDialog()">
                <i class="fas fa-image"></i>
                Logo
              </a>
            <% } %>
            <a href="#" onclick="openFeedbackDialog()">
              <i class="fas fa-comment-dots"></i>
              Feedback
            </a>
          </div>
        </div>
        <h1>Donation List</h1>
      </div>
      <div class="header-right">
        <button class="sync-button" onclick="syncWithQuickbooks()">
          <i class="fas fa-sync-alt"></i>
          Sync with Quickbooks
        </button>
        <% if (isLoggedInToQuickbooks) { %>
          <button class="logout-button" onclick="logoutFromQuickbooks()" style="background-color: #dc3545; margin-left: 10px;">
            <i class="fas fa-sign-out-alt"></i>
            Logout
          </button>
        <% } %>
      </div>
    </div>
    <table>
      <caption>
        <div class="table-header">
          <h2>Donations</h2>
          <div class="search-container">
            <input type="text" id="tableSearch" placeholder="Search donations..." class="search-input" onkeyup="filterTable()">
            <div class="search-suggestions" id="searchSuggestions"></div>
          </div>
        </div>
      </caption>
     
      <thead>
        <tr>
          <th class="sortable" data-column="date" onclick="sortTable('date')">
            Date <i class="fas fa-sort"></i>
          </th>
          <th class="sortable" data-column="donor_name" onclick="sortTable('donor_name')">
            Name <i class="fas fa-sort"></i>
          </th>
          <th class="sortable" data-column="description" onclick="sortTable('description')">
            Description <i class="fas fa-sort"></i>
          </th>
          <th class="sortable" data-column="amount" onclick="sortTable('amount')">
            Amount <i class="fas fa-sort"></i>
          </th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <% data.forEach(function(row) { %>
          <tr data-donor-email="<%= row.donor_email || '' %>">
            <td>
              <% if (row.date) { %>
                <% 
                  const date = new Date(row.date);
                  const month = (date.getMonth() + 1).toString().padStart(2, '0');
                  const day = date.getDate().toString().padStart(2, '0');
                  const year = date.getFullYear().toString().slice(-2);
                  const formattedDate = `${month}-${day}-${year}`;
                %>
                <%= formattedDate %>
              <% } else { %>
                -
              <% } %>
            </td>
            <td><%= row.donor_name %></td>
            <td>
              <% if (row.hasMultipleItems) { %>
                <a href="#" class="multiple-items-link" onclick="showTransactionItems('<%= row.id %>')">
                  Multiple Donations
                </a>
              <% } else { %>
                <span class="editable-description" 
                      contenteditable="true" 
                      data-transaction-id="<%= row.id %>"
                      data-item-id="<%= row.itemId || '' %>"
                      onblur="saveDescription(this)"
                      onkeydown="handleDescriptionKeydown(event, this)"><%= row.description || '' %></span>
              <% } %>
            </td>
            <td><%= new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(parseFloat(row.amount) || 0) %></td>
            <td>
              <% if (row.hasReceipt) { %>
                <i class="fa-regular fa-file-pdf icon" 
                   title="View Receipt" 
                   onclick="openReceipt('<%= row.id %>')"></i>
              <% } %>
              <i class="fa-solid fa-receipt icon" 
                 title="Generate Receipt" 
                 onclick="generateReceipt('<%= row.id %>')"
                 <% if (row.hasReceipt) { %>style="margin-left: 10px;"<% } %>></i>
              <% if (row.hasReceipt) { %>
                <i class="fas fa-envelope icon" 
                   title="Email Receipt" 
                   onclick="openEmailDialog('<%= row.id %>')"
                   style="margin-left: 10px; color: #007bff;"></i>
              <% } %>
            </td>
          </tr>
        <% }); %>
      </tbody>
    </table>
  </div>

  <!-- PDF Viewer Modal -->
  <div id="pdfModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Receipt</h2>
        <span class="close" onclick="closePdfModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div id="pdfContainer">
          <iframe id="pdfViewer" width="100%" frameborder="0"></iframe>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closePdfModal()">Close</button>
        <button class="btn btn-primary" onclick="downloadPdf()">Download PDF</button>
      </div>
    </div>
  </div>

  <!-- Organization Settings Modal -->
  <div id="organizationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Organization Settings</h2>
        <span class="close" onclick="closeOrganizationModal()">&times;</span>
      </div>
      <div class="modal-body">
        <form id="organizationForm">
          <div class="form-row-2">
            <div class="form-group">
              <label for="orgName">Organization Name *</label>
              <input type="text" id="orgName" name="name" required>
            </div>
            <div class="form-group">
              <label for="orgEin">EIN (Employer Identification Number)</label>
              <input type="text" id="orgEin" name="ein" placeholder="XX-XXXXXXX">
            </div>
          </div>
          
          <div class="form-group">
            <label for="orgAddress">Address</label>
            <input type="text" id="orgAddress" name="address">
          </div>
          
          <div class="form-row-3">
            <div class="form-group">
              <label for="orgCity">City</label>
              <input type="text" id="orgCity" name="city">
            </div>
            <div class="form-group">
              <label for="orgState">State</label>
              <input type="text" id="orgState" name="state" maxlength="2">
            </div>
            <div class="form-group">
              <label for="orgZip">ZIP Code</label>
              <input type="text" id="orgZip" name="zip">
            </div>
          </div>
          
          <div class="form-row-2">
            <div class="form-group">
              <label for="orgEmail">Email</label>
              <input type="email" id="orgEmail" name="email">
            </div>
            <div class="form-group">
              <label for="orgPhone">Phone</label>
              <input type="tel" id="orgPhone" name="phone" placeholder="(555) 123-4567">
              <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">Format: (xxx) xxx-xxxx</small>
            </div>
          </div>
          
          <div class="form-row-2">
            <div class="form-group">
              <label for="orgContact">Primary Contact</label>
              <input type="text" id="orgContact" name="contact">
            </div>
            <div class="form-group">
              <label for="orgUrl">Website URL</label>
              <input type="url" id="orgUrl" name="url" placeholder="https://www.example.com">
            </div>
          </div>
          
          <div class="form-group">
            <label for="orgType">Organization Type *</label>
            <select id="orgType" name="type" required>
              <option value="Non-Profit">Non-Profit</option>
              <option value="For-Profit">For-Profit</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeOrganizationModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveOrganization()">Save</button>
      </div>
    </div>
  </div>

  <!-- Logo Management Modal -->
  <div id="logoModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Logo Management</h2>
        <span class="close" onclick="closeLogoModal()">&times;</span>
      </div>
      <div class="modal-body">
        <form id="logoForm">
          <div class="logo-section">
            <div class="logo-preview">
              <div id="logoPreview" class="logo-placeholder">
                <i class="fas fa-image"></i>
                <p>No logo uploaded</p>
              </div>
            </div>
            <div class="logo-controls">
              <div class="form-group">
                <label for="logoFile">Upload Logo</label>
                <input type="file" id="logoFile" accept="image/*" onchange="previewLogo(this)">
                <small>Supported formats: PNG, JPG, JPEG, GIF (max 5MB, max 2048x2048px)</small>
                <div id="fileInfo" class="file-info" style="display: none; margin-top: 5px; padding: 5px; background: #f8f9fa; border-radius: 3px; font-size: 12px;">
                  <span id="fileName"></span> - <span id="fileSize"></span>
                </div>
              </div>
              <div class="form-group">
                <label for="logoPosition">Logo Position</label>
                <select id="logoPosition" name="position">
                  <option value="top-left">Top Left</option>
                  <option value="top-center">Top Center</option>
                  <option value="top-right">Top Right</option>
                </select>
              </div>
              <div class="form-group">
                <label for="logoWidth">Logo Width (px)</label>
                <input type="number" id="logoWidth" name="width" min="50" max="300" value="150">
              </div>
              <div class="form-group">
                <label for="logoHeight">Logo Height (px)</label>
                <input type="number" id="logoHeight" name="height" min="30" max="200" value="80">
              </div>
              <button class="btn btn-danger" onclick="deleteLogo()" id="deleteLogoBtn" style="display: none;">
                <i class="fas fa-trash"></i>
                Delete Logo
              </button>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeLogoModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveLogo()">Save</button>
      </div>
    </div>
  </div>

  <!-- Welcome Dialog -->
  <div id="welcomeModal" class="modal">
    <div class="modal-content welcome-modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-hand-wave"></i> Welcome!</h2>
        <span class="close" onclick="closeWelcomeModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="welcome-content">
          <div class="welcome-icon">
            <i class="fas fa-file-invoice-dollar"></i>
          </div>
          <h3>Donation Receipt Manager</h3>
          <p class="welcome-description">This application helps you manage donation receipts efficiently.</p>
          
          <div class="welcome-steps">
            <div class="welcome-step">
              <div class="step-number">1</div>
              <div class="step-content">
                <h4><i class="fas fa-cloud-download-alt"></i> Import from QuickBooks</h4>
                <p>We import transactions from QuickBooks Sales Receipts. If you track your donations using another method, please leave us feedback and we can add that.</p>
              </div>
            </div>
            
            <div class="welcome-step">
              <div class="step-number">2</div>
              <div class="step-content">
                <h4><i class="fas fa-file-pdf"></i> Generate Receipt Letters</h4>
                <p>Create professional PDF receipts for each donation</p>
              </div>
            </div>
            
            <div class="welcome-step">
              <div class="step-number">3</div>
              <div class="step-content">
                <h4><i class="fas fa-envelope"></i> Email or Send to Donors</h4>
                <p>Send receipts directly to donors via email</p>
              </div>
            </div>
          </div>
          
          <div class="welcome-actions">
            <button class="btn btn-primary btn-large" onclick="closeWelcomeModal()">
              <i class="fas fa-rocket"></i> Get Started
            </button>
            <label class="welcome-checkbox">
              <input type="checkbox" id="dontShowAgain" onchange="updateWelcomePreference()">
              Don't show this again
            </label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Terms of Service Modal -->
  <div id="termsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Terms of Service</h2>
        <span class="close" onclick="closeTermsModal()">&times;</span>
      </div>
      <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
        <div class="terms-content">
          <h3>Reznim Donation Receipt App &ndash; Terms of Service</h3>

          <p class="terms-note"><em>To continue using the app, close this dialog after review and choose "Accept All" on the cookie banner below.</em></p>

          <h4>1. Overview</h4>
          <p>Welcome to Donation Receipt App (&ldquo;the App,&rdquo; &ldquo;we,&rdquo; &ldquo;us,&rdquo; or &ldquo;our&rdquo;). Donation Receipt App allows businesses to connect their QuickBooks Online accounts to generate donation receipts, including donor and sales receipt information. By accessing or using the App, you agree to these Terms of Service (&ldquo;Terms&rdquo;). If you do not agree, please do not use the App.</p>

          <h4>2. Eligibility and Business Use</h4>
          <p>Donation Generator is intended for business use only. By using the App, you represent that you are authorized to act on behalf of your organization and to bind it to these Terms.</p>

          <h4>3. Connection to QuickBooks</h4>
          <p>You connect to QuickBooks Online through Intuit&rsquo;s OAuth 2.0 authentication. We do not store your QuickBooks username, password, or access credentials. By connecting your QuickBooks account, you grant us permission to access specific data authorized by you through Intuit&rsquo;s API. Your use of QuickBooks Online is also governed by Intuit&rsquo;s Terms of Service and Privacy Policy.</p>

          <h4>4. Data We Collect and Store</h4>
          <p>Donation Generator may store limited business data retrieved from QuickBooks, including sales receipts, donor information, and company information (including Tax ID, which is encrypted at rest). We do not access or store any unrelated QuickBooks data unless explicitly authorized by you during OAuth connection.</p>

          <h4>5. Data Security</h4>
          <p>Tax ID and other sensitive information are encrypted using industry-standard encryption methods. We use reasonable technical and organizational measures to protect stored data. However, no method of transmission or storage is 100% secure, and we cannot guarantee absolute security.</p>

          <h4>6. Data Ownership and Usage</h4>
          <p>All data imported from your QuickBooks account remains your property. We use the data solely to provide the functionality of the App and do not sell, share, or monetize it. You may disconnect your QuickBooks account at any time, which will revoke our access to your data.</p>

          <h4>7. Free Service</h4>
          <p>Donation Generator is provided free of charge. We may introduce optional paid features or enhancements in the future, in which case updated terms will apply.</p>

          <h4>8. Service Availability and Modifications</h4>
          <p>We may update, modify, or discontinue the App or any part of it at any time without prior notice. We do not guarantee uninterrupted or error-free operation.</p>

          <h4>9. Disclaimers</h4>
          <p>The App is provided &ldquo;as is&rdquo; and &ldquo;as available.&rdquo; We make no warranties, express or implied, about the App&rsquo;s accuracy, reliability, or suitability for any particular purpose. You assume full responsibility for your use of the App and any resulting data.</p>

          <h4>10. Limitation of Liability</h4>
          <p>To the maximum extent permitted by law, we are not liable for any indirect, incidental, special, or consequential damages arising from your use of the App. Our total liability under these Terms will not exceed $100.</p>

          <h4>11. Termination</h4>
          <p>You may stop using the App at any time. We may suspend or terminate your access at our discretion if you violate these Terms or if we discontinue the service.</p>

          <h4>12. Compliance with Laws and Intuit Policies</h4>
          <p>You agree to use Donation Generator in compliance with all applicable laws and Intuit Developer Policies, including restrictions on storing or handling QuickBooks data.</p>

          <h4>13. Governing Law</h4>
          <p>These Terms are governed by and construed in accordance with the laws of the United States and the state of [Insert State], without regard to conflict of laws principles.</p>

          <h4>14. Changes to These Terms</h4>
          <p>We may update these Terms from time to time. The updated version will be posted with a new effective date. Your continued use of the App after updates constitutes acceptance of the new Terms.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeTermsModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Privacy Policy Modal -->
  <div id="privacyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Privacy Policy</h2>
        <span class="close" onclick="closePrivacyModal()">&times;</span>
      </div>
      <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
        <div class="terms-content">
          <h3>Reznim Donation Receipt App &ndash; Privacy Policy</h3>

          <p>This Privacy Policy explains how we collect, use, and safeguard the business information retrieved from your QuickBooks Online account while using the Donation Receipt App (&ldquo;the App&rdquo;).</p>

          <h4>Information We Collect</h4>
          <p>When you authorize the App through Intuit&rsquo;s OAuth 2.0 connection, we may retrieve sales receipts, donor information, and organization details (including Tax ID). We do not access any other QuickBooks data unless you specifically authorize it.</p>

          <h4>How We Use Information</h4>
          <p>We use the imported data solely to provide donation receipt functionality within the App. We do not sell, share, or monetize the data.</p>

          <h4>Data Storage & Security</h4>
          <p>Tax IDs and other sensitive fields are encrypted using industry-standard methods. While we take reasonable steps to protect information, no system can guarantee absolute security.</p>

          <h4>Your Choices</h4>
          <p>You can disconnect your QuickBooks account at any time to revoke our access. Please email support@reznim.com if you would like your locally stored data purged.</p>

          <h4>Changes</h4>
          <p>We may update this Privacy Policy periodically. Continued use of the App after changes constitutes acceptance of the updated policy.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closePrivacyModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Feedback Modal -->
  <div id="feedbackModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-comment-dots"></i> Feedback</h2>
        <span class="close" onclick="closeFeedbackModal()">&times;</span>
      </div>
      <div class="modal-body">
        <form id="feedbackForm">
          <div class="form-group">
            <label for="feedbackEmail">Email (optional)</label>
            <input type="email" id="feedbackEmail" name="email" placeholder="your@email.com">
          </div>
          
          <div class="form-group">
            <label for="feedbackText">Your Feedback *</label>
            <textarea id="feedbackText" name="feedback" rows="6" required placeholder="Share your thoughts, suggestions, or report any issues..."></textarea>
          </div>
          
          <div class="form-group">
            <label for="feedbackRating">How would you rate your experience? *</label>
            <div class="rating-container">
              <input type="range" id="feedbackRating" name="rating" min="1" max="10" value="5" oninput="updateRatingValue(this.value)">
              <div class="rating-display">
                <span id="ratingValue">5</span>
                <span class="rating-label">/ 10</span>
              </div>
            </div>
            <div class="rating-labels">
              <span>Poor</span>
              <span>Excellent</span>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeFeedbackModal()">Cancel</button>
        <button class="btn btn-primary" onclick="submitFeedback()">Submit Feedback</button>
      </div>
    </div>
  </div>

  <!-- Email Receipt Modal -->
  <div id="emailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Email Receipt</h2>
        <span class="close" onclick="closeEmailModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="emailAddress">Email Address:</label>
          <input type="email" id="emailAddress">
        </div>
        <div class="form-group">
          <label for="emailSubject">Subject:</label>
          <input type="text" id="emailSubject" value="Your Donation Receipt">
        </div>
        <div class="form-group">
          <label for="emailMessage">Message:</label>
          <textarea id="emailMessage" rows="4" placeholder="Optional personal message..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeEmailModal()">Cancel</button>
        <button class="btn btn-primary" onclick="sendReceiptEmail()">Send Email</button>
      </div>
    </div>
  </div>

  <!-- Transaction Items Modal -->
  <div id="itemsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Transaction Items</h2>
        <span class="close" onclick="closeItemsModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div id="itemsList">
          <!-- Items will be populated here -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeItemsModal()">Close</button>
      </div>
    </div>
  </div>

  <footer class="page-footer">
    <p>
      &copy; 2025 Reznim, LLC
      <span class="footer-separator">|</span>
      <a href="#" data-open-modal="terms">Terms of Service</a>
      <span class="footer-separator">|</span>
      <a href="#" data-open-modal="privacy">Privacy Policy</a>
    </p>
  </footer>

  <!-- Cookie Consent Banner -->
  <div id="cookieBanner" class="cookie-banner" style="display: none;">
    <div class="cookie-banner-content">
      <p class="cookie-banner-text">
        We use cookies to enhance your user experience. By using our website and services, you consent to our 
        <a href="#" data-open-modal="terms" style="color: #007bff; text-decoration: underline;">Terms of Service</a> 
        and <a href="#" data-open-modal="privacy" style="color: #007bff; text-decoration: underline;">Privacy Policy</a>.
      </p>
      <div class="cookie-banner-buttons">
        <button class="btn btn-secondary" onclick="rejectAllCookies()">Reject All</button>
        <button class="btn btn-primary" onclick="acceptAllCookies()">Accept All</button>
      </div>
    </div>
  </div>

  <div id="app-data" data-logged-in="<%- isLoggedInToQuickbooks ? 'true' : 'false' %>" style="display: none;"></div>
  <script>
    // Make server-side variables available to JavaScript
    var isLoggedInToQuickbooks = document.getElementById('app-data').getAttribute('data-logged-in') === 'true';
  </script>
  <script src="/js/script.js"></script>
</body>
</html> 