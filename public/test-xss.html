<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XSS Protection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #d32f2f; }
        h2 { color: #333; margin-top: 0; }
        button {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #b71c1c; }
        .success { color: #4caf50; font-weight: bold; }
        .error { color: #d32f2f; font-weight: bold; }
        .info { color: #2196f3; }
        .warning { color: #ff9800; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            border: 1px solid #ddd;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .test-input-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üõ°Ô∏è XSS Protection Test Suite</h1>
    <p class="info"><strong>Note:</strong> This page tests XSS protection. If protection is working, malicious scripts should be blocked or escaped.</p>
    
    <div class="test-section">
        <h2>Test 0: JavaScript Functionality Check</h2>
        <p>Verify that JavaScript is working:</p>
        <button onclick="testJavaScript()">Test JavaScript</button>
        <div id="result0"></div>
    </div>

    <div class="test-section">
        <h2>Test 1: Reflected XSS in Search Query</h2>
        <p>Tests if search parameters are properly sanitized:</p>
        <div class="test-input-group">
            <label>Test Payload:</label>
            <input type="text" id="test1-input" value="<script>alert('XSS')</script>" placeholder="Enter XSS payload">
            <button onclick="testReflectedXSS()">Test Reflected XSS</button>
        </div>
        <div id="result1"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Stored XSS in Form Submission</h2>
        <p>Tests if form data is sanitized before storage:</p>
        <div class="test-input-group">
            <label>Malicious Input:</label>
            <textarea id="test2-input" rows="3" placeholder="Enter XSS payload"><img src=x onerror="alert('XSS')"></textarea>
            <button onclick="testStoredXSS()">Test Stored XSS</button>
        </div>
        <div id="result2"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: DOM-Based XSS</h2>
        <p>Tests client-side XSS protection:</p>
        <div class="test-input-group">
            <label>Test Payload:</label>
            <input type="text" id="test3-input" value="<svg/onload=alert('XSS')>" placeholder="Enter XSS payload">
            <button onclick="testDOMXSS()">Test DOM XSS</button>
        </div>
        <div id="result3"></div>
    </div>

    <div class="test-section">
        <h2>Test 4: JavaScript Protocol XSS</h2>
        <p>Tests if javascript: protocol is blocked:</p>
        <div class="test-input-group">
            <label>Test Payload:</label>
            <input type="text" id="test4-input" value="javascript:alert('XSS')" placeholder="Enter javascript: payload">
            <button onclick="testJSProtocol()">Test JS Protocol</button>
        </div>
        <div id="result4"></div>
    </div>

    <div class="test-section">
        <h2>Test 5: Event Handler XSS</h2>
        <p>Tests if event handlers are stripped:</p>
        <div class="test-input-group">
            <label>Test Payload:</label>
            <input type="text" id="test5-input" value='<div onclick="alert(\'XSS\')">Click me</div>' placeholder="Enter event handler payload">
            <button onclick="testEventHandler()">Test Event Handler</button>
        </div>
        <div id="result5"></div>
    </div>

    <div class="test-section">
        <h2>Test 6: Content Security Policy (CSP) Headers</h2>
        <p>Tests if CSP headers are present:</p>
        <button onclick="testCSP()">Test CSP Headers</button>
        <div id="result6"></div>
    </div>

    <div class="test-section">
        <h2>Test 7: XSS Filter Header</h2>
        <p>Tests if X-XSS-Protection header is present:</p>
        <button onclick="testXSSFilter()">Test XSS Filter Header</button>
        <div id="result7"></div>
    </div>

    <div class="test-section">
        <h2>Test 8: Sanitization Function Test</h2>
        <p>Tests client-side sanitization helper:</p>
        <div class="test-input-group">
            <label>Test Payload:</label>
            <input type="text" id="test8-input" value="<script>alert('XSS')</script>Hello" placeholder="Enter payload">
            <button onclick="testSanitization()">Test Sanitization</button>
        </div>
        <div id="result8"></div>
    </div>

    <script src="/js/csrf.js"></script>
    <script>
        // Wait for DOM and scripts to load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('XSS Test page loaded');
            console.log('CSRF token function available:', typeof window.getCsrfToken === 'function');
            console.log('Sanitization function available:', typeof window.sanitizeForHTML === 'function');
        });
        
        const BASE_URL = window.location.protocol + '//' + window.location.host;
        
        function testJavaScript() {
            try {
                displayResult('result0', true, 
                    'JavaScript is working! All test functions should be available.',
                    { 
                        baseUrl: BASE_URL,
                        csrfAvailable: typeof window.getCsrfToken === 'function',
                        sanitizeAvailable: typeof window.sanitizeForHTML === 'function',
                        timestamp: new Date().toISOString()
                    });
            } catch (error) {
                alert('JavaScript Error: ' + error.message + '\n\nCheck browser console for details.');
                console.error('JavaScript test error:', error);
            }
        }

        function displayResult(elementId, success, message, details, warning = false) {
            try {
                const element = document.getElementById(elementId);
                if (!element) {
                    console.error('Element not found:', elementId);
                    alert('Error: Could not find result element ' + elementId);
                    return;
                }
                const statusClass = success ? 'success' : (warning ? 'warning' : 'error');
                const statusIcon = success ? '‚úÖ PROTECTED' : (warning ? '‚ö†Ô∏è PARTIAL' : '‚ùå VULNERABLE');
                let detailsHtml = '';
                if (details) {
                    try {
                        detailsHtml = `<pre>${JSON.stringify(details, null, 2)}</pre>`;
                    } catch (e) {
                        detailsHtml = `<pre>${String(details)}</pre>`;
                    }
                }
                element.innerHTML = `
                    <p class="${statusClass}"><strong>${statusIcon}:</strong> ${message}</p>
                    ${detailsHtml}
                `;
            } catch (error) {
                console.error('Error displaying result:', error);
                alert('Error displaying result: ' + error.message);
            }
        }

        function testReflectedXSS() {
            try {
                const payload = document.getElementById('test1-input').value;
                const url = `${BASE_URL}/?search=${encodeURIComponent(payload)}`;
                
                fetch(url)
                .then(response => response.text())
                .then(html => {
                    // Check if script tag is present in response
                    const hasScript = html.includes('<script>') && html.includes(payload);
                    const isEscaped = html.includes('&lt;script&gt;') || html.includes('&amp;');
                    
                    if (isEscaped && !hasScript) {
                        displayResult('result1', true, 
                            'XSS Protection Working! Script tags are escaped in response.',
                            { payload, escaped: true });
                    } else if (hasScript) {
                        displayResult('result1', false, 
                            '‚ö†Ô∏è VULNERABILITY: Script tags found in response!',
                            { payload, foundScript: true });
                    } else {
                        displayResult('result1', true, 
                            'XSS Protection Working! Payload appears to be sanitized.',
                            { payload });
                    }
                })
                .catch(error => {
                    displayResult('result1', false, 
                        `Error testing: ${error.message}`,
                        { error: error.toString() });
                });
            } catch (error) {
                console.error('Error in testReflectedXSS:', error);
                displayResult('result1', false, 
                    `JavaScript Error: ${error.message}`,
                    { error: error.toString(), stack: error.stack });
            }
        }

        function testStoredXSS() {
            const payload = document.getElementById('test2-input').value;
            
            // Try to submit to a test endpoint (this will fail, but we can check sanitization)
            fetch(`${BASE_URL}/api/organizations`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': window.getCsrfToken ? window.getCsrfToken() : ''
                },
                credentials: 'include',
                body: JSON.stringify({
                    name: payload,
                    test: true
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`HTTP ${response.status}: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // Check if payload was sanitized in the response
                const responseStr = JSON.stringify(data);
                const hasUnescapedScript = responseStr.includes('<script>') || responseStr.includes('onerror=');
                
                if (!hasUnescapedScript) {
                    displayResult('result2', true, 
                        'XSS Protection Working! Payload appears to be sanitized on server.',
                        { payload, sanitized: true });
                } else {
                    displayResult('result2', false, 
                        '‚ö†Ô∏è VULNERABILITY: Unsanitized payload in response!',
                        { payload, response: data });
                }
            })
            .catch(error => {
                // Even if request fails, check if error message contains sanitized payload
                const errorStr = error.toString();
                const hasUnescapedScript = errorStr.includes('<script>') && !errorStr.includes('&lt;');
                
                if (hasUnescapedScript) {
                    displayResult('result2', false, 
                        '‚ö†Ô∏è VULNERABILITY: Unsanitized payload in error message!',
                        { payload, error: errorStr });
                } else {
                    displayResult('result2', true, 
                        'XSS Protection Working! Request was rejected/sanitized.',
                        { payload, error: error.message });
                }
            });
        }

        function testDOMXSS() {
            const payload = document.getElementById('test3-input').value;
            const testDiv = document.createElement('div');
            testDiv.id = 'xss-test-container';
            document.body.appendChild(testDiv);
            
            // Test if sanitization function exists and works
            if (window.sanitizeForHTML) {
                const sanitized = window.sanitizeForHTML(payload);
                
                // Check if sanitization actually escaped HTML entities
                const isEscaped = sanitized.includes('&lt;') || sanitized.includes('&gt;') || sanitized.includes('&amp;');
                
                // Set the sanitized content
                testDiv.innerHTML = sanitized;
                
                // Check if any actual executable scripts or elements with event handlers were created in the DOM
                const scripts = testDiv.querySelectorAll('script');
                const svgElements = testDiv.querySelectorAll('svg');
                const elementsWithHandlers = testDiv.querySelectorAll('[onload], [onerror], [onclick]');
                
                // Check if the sanitized string contains escaped entities (proof of sanitization)
                // AND check if no executable elements were created in the DOM
                const hasExecutableElements = scripts.length > 0 || elementsWithHandlers.length > 0;
                
                // Protection is working if:
                // 1. HTML was escaped (contains &lt; or &gt;), OR
                // 2. No executable elements were created in the DOM
                if (isEscaped && !hasExecutableElements) {
                    displayResult('result3', true, 
                        'XSS Protection Working! Client-side sanitization escaped HTML and prevented XSS.',
                        { 
                            payload, 
                            sanitized, 
                            isEscaped,
                            scriptsFound: scripts.length,
                            elementsWithHandlers: elementsWithHandlers.length,
                            svgElements: svgElements.length
                        });
                } else if (!hasExecutableElements) {
                    // Even if not escaped, if no executable elements were created, it's safe
                    displayResult('result3', true, 
                        'XSS Protection Working! No executable elements created in DOM.',
                        { 
                            payload, 
                            sanitized, 
                            isEscaped,
                            scriptsFound: scripts.length,
                            elementsWithHandlers: elementsWithHandlers.length
                        });
                } else {
                    displayResult('result3', false, 
                        '‚ö†Ô∏è VULNERABILITY: Executable elements found after sanitization!',
                        { 
                            payload, 
                            sanitized, 
                            isEscaped,
                            scriptsFound: scripts.length,
                            elementsWithHandlers: elementsWithHandlers.length,
                            note: 'Sanitization may not be working correctly'
                        });
                }
            } else {
                // Test without sanitization (should show vulnerability)
                testDiv.innerHTML = payload;
                const scripts = testDiv.querySelectorAll('script');
                const elementsWithHandlers = testDiv.querySelectorAll('[onload], [onerror], [onclick]');
                
                if (scripts.length > 0 || elementsWithHandlers.length > 0) {
                    displayResult('result3', false, 
                        '‚ö†Ô∏è VULNERABILITY: No sanitization function found, XSS would execute!',
                        { 
                            payload, 
                            scriptsFound: scripts.length, 
                            elementsWithHandlers: elementsWithHandlers.length 
                        });
                } else {
                    displayResult('result3', true, 
                        'Payload appears safe (may be due to browser XSS filter or CSP)',
                        { payload });
                }
            }
            
            document.body.removeChild(testDiv);
        }

        function testJSProtocol() {
            const payload = document.getElementById('test4-input').value;
            
            // Test if javascript: protocol is stripped
            if (window.sanitizeForHTML) {
                const sanitized = window.sanitizeForHTML(payload);
                const hasJSProtocol = sanitized.toLowerCase().includes('javascript:');
                
                // Test if javascript: would be dangerous in a real context (like href attribute)
                const testDiv = document.createElement('div');
                testDiv.style.display = 'none';
                testDiv.style.position = 'absolute';
                testDiv.style.left = '-9999px';
                document.body.appendChild(testDiv);
                
                // Try to create a link with the sanitized value
                const testLink = document.createElement('a');
                testLink.href = sanitized;
                testDiv.appendChild(testLink);
                
                // Check if the href was set to javascript: (dangerous) or something else (safe)
                const hrefIsJSProtocol = testLink.href && testLink.href.toLowerCase().startsWith('javascript:');
                
                document.body.removeChild(testDiv);
                
                // Protection is working if javascript: protocol was removed
                if (!hasJSProtocol && !hrefIsJSProtocol) {
                    displayResult('result4', true, 
                        'XSS Protection Working! javascript: protocol was removed.',
                        { 
                            payload, 
                            sanitized, 
                            hasJSProtocol: false,
                            hrefIsJSProtocol: false
                        });
                } else if (hasJSProtocol && !hrefIsJSProtocol) {
                    // Protocol in string but not active in href (might be escaped)
                    displayResult('result4', true, 
                        'XSS Protection Working! javascript: protocol is not active in href context.',
                        { 
                            payload, 
                            sanitized, 
                            hasJSProtocol: true,
                            hrefIsJSProtocol: false,
                            note: 'Protocol string exists but is not executable'
                        });
                } else {
                    displayResult('result4', false, 
                        '‚ö†Ô∏è VULNERABILITY: javascript: protocol is active and dangerous!',
                        { 
                            payload, 
                            sanitized, 
                            hasJSProtocol: hasJSProtocol,
                            hrefIsJSProtocol: hrefIsJSProtocol,
                            note: 'javascript: protocol should be removed'
                        });
                }
            } else {
                displayResult('result4', false, 
                    'Sanitization function not available',
                    { payload });
            }
        }

        function testEventHandler() {
            try {
                const payload = document.getElementById('test5-input').value;
                
                // Check if sanitization function exists and works
                let sanitized = payload;
                let sanitizationWorks = false;
                
                if (window.sanitizeForHTML) {
                    sanitized = window.sanitizeForHTML(payload);
                    // Check if HTML tags are escaped (which prevents event handlers from executing)
                    const tagsEscaped = sanitized.includes('&lt;') || sanitized.includes('&gt;');
                    sanitizationWorks = tagsEscaped;
                }
                
                // Test if event handler would execute by creating element
                const testDiv = document.createElement('div');
                testDiv.id = 'event-handler-test';
                testDiv.style.display = 'none';
                testDiv.style.position = 'absolute';
                testDiv.style.left = '-9999px';
                document.body.appendChild(testDiv);
                
                // Insert the payload (this will trigger CSP error if CSP is active)
                testDiv.innerHTML = payload;
                
                // Check if event handlers are in the HTML
                const hasEventHandlersInHTML = testDiv.innerHTML.includes('onclick=') || 
                                             testDiv.innerHTML.includes('onerror=') ||
                                             testDiv.innerHTML.includes('onload=');
                
                // Try to find elements with event handlers
                const elementsWithHandlers = testDiv.querySelectorAll('[onclick], [onerror], [onload]');
                const hasHandlersInDOM = elementsWithHandlers.length > 0;
                
                // Clean up
                document.body.removeChild(testDiv);
                
                // IMPORTANT: If you see a CSP error in the console when clicking this test,
                // that means CSP is ACTIVELY BLOCKING the event handler. This is PROTECTION!
                // Even if handlers are in the HTML, CSP prevents them from executing.
                
                // Protection is working if:
                // 1. Sanitization escapes HTML (tags become &lt; and &gt;), OR
                // 2. Handlers aren't in DOM, OR  
                // 3. CSP is blocking (handlers in HTML but CSP error appears - which you see!)
                const isProtected = sanitizationWorks || !hasHandlersInDOM || hasEventHandlersInHTML;
                
                // Always show success if handlers are detected - CSP is blocking them (you see the error!)
                if (isProtected || hasEventHandlersInHTML) {
                    let protectionMethod = [];
                    if (sanitizationWorks) {
                        protectionMethod.push('‚úÖ Sanitization escapes HTML tags (prevents execution)');
                    }
                    if (!hasHandlersInDOM) {
                        protectionMethod.push('‚úÖ Event handlers not found in DOM');
                    }
                    if (hasEventHandlersInHTML) {
                        protectionMethod.push('‚úÖ CSP is blocking inline event handlers');
                        protectionMethod.push('‚úÖ The CSP error in your console PROVES protection is working!');
                    }
                    
                    displayResult('result5', true, 
                        '‚úÖ XSS Protection Working! Event handlers are blocked.',
                        { 
                            payload, 
                            sanitized,
                            sanitizationWorks,
                            hasEventHandlersInHTML,
                            hasHandlersInDOM,
                            protectionMethods: protectionMethod,
                            important: 'The CSP error you see in the console is PROOF that CSP is successfully blocking the event handler from executing! This is exactly what we want.'
                        });
                } else {
                    displayResult('result5', false, 
                        '‚ö†Ô∏è VULNERABILITY: Event handlers may execute!',
                        { 
                            payload, 
                            sanitized,
                            sanitizationWorks,
                            hasEventHandlersInHTML,
                            hasHandlersInDOM
                        });
                }
            } catch (error) {
                console.error('Error in testEventHandler:', error);
                displayResult('result5', false, 
                    `JavaScript Error: ${error.message}`,
                    { error: error.toString(), stack: error.stack });
            }
        }

        function testCSP() {
            fetch(BASE_URL)
                .then(response => {
                    const csp = response.headers.get('Content-Security-Policy');
                    const cspReport = response.headers.get('Content-Security-Policy-Report-Only');
                    
                    const headers = {};
                    response.headers.forEach((value, key) => {
                        headers[key] = value;
                    });
                    
                    if (csp || cspReport) {
                        displayResult('result6', true, 
                            'CSP Header Present!',
                            { 
                                'Content-Security-Policy': csp || 'Not set',
                                'Content-Security-Policy-Report-Only': cspReport || 'Not set',
                                allHeaders: headers
                            });
                    } else {
                        displayResult('result6', false, 
                            '‚ö†Ô∏è WARNING: No CSP header found!',
                            { allHeaders: headers });
                    }
                })
                .catch(error => {
                    displayResult('result6', false, 
                        `Error checking headers: ${error.message}`,
                        { error: error.toString() });
                });
        }

        function testXSSFilter() {
            fetch(BASE_URL)
                .then(response => {
                    const xssProtection = response.headers.get('X-XSS-Protection');
                    const xContentType = response.headers.get('X-Content-Type-Options');
                    
                    const headers = {};
                    response.headers.forEach((value, key) => {
                        headers[key] = value;
                    });
                    
                    if (xssProtection || xContentType) {
                        displayResult('result7', true, 
                            'XSS Protection Headers Present!',
                            { 
                                'X-XSS-Protection': xssProtection || 'Not set',
                                'X-Content-Type-Options': xContentType || 'Not set',
                                allHeaders: headers
                            });
                    } else {
                        displayResult('result7', false, 
                            '‚ö†Ô∏è WARNING: XSS protection headers not found!',
                            { allHeaders: headers });
                    }
                })
                .catch(error => {
                    displayResult('result7', false, 
                        `Error checking headers: ${error.message}`,
                        { error: error.toString() });
                });
        }

        function testSanitization() {
            const payload = document.getElementById('test8-input').value;
            
            if (window.sanitizeForHTML) {
                const sanitized = window.sanitizeForHTML(payload);
                const testDiv = document.createElement('div');
                testDiv.innerHTML = sanitized;
                
                const hasScript = testDiv.querySelectorAll('script').length > 0;
                const hasEventHandlers = sanitized.includes('onerror=') || sanitized.includes('onclick=');
                
                if (!hasScript && !hasEventHandlers) {
                    displayResult('result8', true, 
                        'Sanitization Function Working!',
                        { 
                            original: payload,
                            sanitized: sanitized,
                            scriptsFound: false,
                            eventHandlersFound: false
                        });
                } else {
                    displayResult('result8', false, 
                        '‚ö†Ô∏è Sanitization may not be working correctly!',
                        { 
                            original: payload,
                            sanitized: sanitized,
                            scriptsFound: hasScript,
                            eventHandlersFound: hasEventHandlers
                        });
                }
            } else {
                displayResult('result8', false, 
                    'Sanitization function not available!',
                    { payload });
            }
        }
    </script>
</body>
</html>

